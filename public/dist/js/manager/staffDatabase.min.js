/*! Spec 0.1.2 */
var splitTrim=function(str){return str.split(",").map(function(x){return x.trim()})},Staff=Backbone.Model.extend({initialize:function(){this.on("change",function(staff){var changed=staff.changed;if("task"===Object.keys(staff.changed)[0]){var oldTasks,prev=staff.previousAttributes(),newTasks=splitTrim(staff.get(Object.keys(staff.changed)[0]));try{oldTasks=prev[Object.keys(staff.changed)[0]],_.isArray(oldTasks)||(oldTasks=splitTrim(oldTasks))}catch(e){}if(_.isEqual(oldTasks,newTasks))return!1;changed={task:newTasks}}console.log("changed: "+staff.get("name")+" -> "+JSON.stringify(changed)),$.ajax({type:"POST",url:"/staff/db/update",data:{id:staff.get("_id"),what:changed}}).done(function(){})})}}),PageableStaffList=Backbone.PageableCollection.extend({model:Staff,url:"/staff/all",state:{pageSize:20},mode:"client"}),pageableStaffList=new PageableStaffList;pageableStaffList.comparator="name",pageableStaffList.sort();var plainInteger=Backgrid.IntegerCell.extend({orderSeparator:""}),columns=[{name:"",cell:"select-row",headerCell:"select-all",renderable:!0},{name:"name",label:"Name",cell:"string",direction:"ascending"},{name:"username",label:"User Name",cell:"string"},{name:"class_year",label:"Class Year",cell:plainInteger},{name:"phone",label:"Phone Number",cell:plainInteger},{name:"level",label:"Permission Level",cell:"integer"},{name:"task",label:"Task",cell:"string"},{name:"professional",label:"Professional",cell:"boolean"},{name:"trainee",label:"Trainee",cell:"boolean"}],pageableGrid=new Backgrid.Grid({columns:columns,collection:pageableStaffList});$stuff=$(".stuff"),$stuff.append(pageableGrid.render().el);var paginator=new Backgrid.Extension.Paginator({collection:pageableStaffList});$stuff.after(paginator.render().el);var filter=new Backgrid.Extension.ClientSideFilter({collection:pageableStaffList,fields:["name"]});$stuff.before(filter.render().el),$(filter.el).css({"float":"right",margin:"20px"}),pageableStaffList.fetch({reset:!0}),$.fn.editable.defaults.mode="inline",$("#newStaff").click(function(){$("#newModal .modal-body").html(_.template($("#newTemplate").html())),$("#professional").editable({value:0,source:[{value:1,text:"Yes"},{value:0,text:"No"}]}),$("#trainee").editable({value:1,source:[{value:1,text:"Yes"},{value:0,text:"No"}]}),$(".x-add").editable({}),$("#name").editable("option","validate",function(v){return v?void 0:"Required field!"}),$("#username").editable("option","validate",function(v){return v?void 0:"Required field!"}),$("#class_year").editable("option","validate",function(v){return v?!/\d{4}/.test(v)||isNaN(new Date(v,0,1))||parseInt(v)<(new Date).getFullYear()?"Enter a valid year for this please!":void 0:"Required field!"}),$("#phone").editable("option","validate",function(v){return v?/^[0-9\-\+]{9,15}$/.test(v)?void 0:"Enter a valid phone number please!":"Required field!"}),$("#level").editable("option","validate",function(v){return v?!/\d{1}/.test(v)&&!/\d{2}/.test(v)||parseInt(v)>10||parseInt(v)<0?"Enter a valid permission level please!":void 0:"Required field!"}),$("#task").editable("option","validate",function(v){if(!v)return"Required field!";try{v=splitTrim(v)}catch(e){return"Please enter a valid list of tasks."}}),$(".x-add").on("save.newuser",function(){var that=this;setTimeout(function(){$(that).closest("tr").next().find(".x-add").editable("show")},200)}),$("#newModal").modal("show")}),$("#newModal .btn-primary").click(function(){$(".x-add").editable("submit",{url:"/staff/db/add",ajaxOptions:{dataType:"json"},success:function(data,config){if(data&&data.errors)config.error.call(this,data.errors);else if(data){pageableStaffList.fetch({reset:!0});var msg="New user created! Now editables submit individually.";$("#msg").addClass("alert-success").removeClass("alert-error").html(msg).show(),$("#newModal").modal("hide")}},error:function(errors){var msg="";errors&&errors.responseText?msg=errors.responseText:$.each(errors,function(k,v){msg+=k+": "+v+"<br>"}),$("#msg").removeClass("alert-success").addClass("alert-error").html(msg).show()}})}),$("#deleteStaff").click(function(){var models=pageableGrid.getSelectedModels();idsToDelete=[],models.forEach(function(model){idsToDelete.push(model.get("_id"))}),$("#deleteModal ul").html(_.template($("#deleteTemplate").html(),{models:models})),$("#deleteModal").modal("show")}),$("#deleteModal .btn-danger").click(function(){idsToDelete.forEach(function(idToDelete){$.ajax({type:"POST",url:"/staff/db/delete",data:{id:idToDelete}}).done(function(){pageableStaffList.fetch({reset:!0})})}),$("#deleteModal").modal("hide")});