/*! Spec 0.1.5 */
var fullShiftNumber=function(a){return a.shifts.map(function(a){return a.staff}).filter(function(a){return a}).length},randomColor=function(){return"#"+Math.floor(16777215*Math.random()).toString(16)},exportCSV=function(a){var b=document.createElement("a");b.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(a)),b.setAttribute("download",""),b.click()},ordinal=function(a){var b=a%10;return 1==b&&11!=a?a+"st":2==b&&12!=a?a+"nd":3==b&&13!=a?a+"rd":a+"th"},getWeek=function(a){var b=new Date(a.getFullYear(),0,1);return[Math.ceil(((a-b)/864e5+b.getDay()+1)/7),a.getFullYear()]},getDaysBetween=function(){var a=new Date($("#d1").data("datepicker").date),b=$("#d2").data("datepicker").date;if(a.getTime()>b.getTime())return[];for(var c=[];a.toDateString()!==b.toDateString();)c.push(a.toDateString()),a.setDate(a.getDate()+1);return c.push(b.toDateString()),c},getWeeksBetween=function(){var a=new Date($("#d1").data("datepicker").date),b=$("#d2").data("datepicker").date;if(a.getTime()>b.getTime())return[];for(var c=getWeek(b),d=[];!_.isEqual(getWeek(a),c);)d.push(getWeek(a)),a.setDate(a.getDate()+7);return d.push(getWeek(b)),d},getMonth=function(a){return[a.getMonth()+1,a.getFullYear()]},getMonthsBetween=function(){var a=new Date($("#d1").data("datepicker").date),b=$("#d2").data("datepicker").date;if(a.getTime()>b.getTime())return[];for(var c=getMonth(b),d=[];!_.isEqual(getMonth(a),c);)d.push(getMonth(a)),a.setDate(a.getDate()+30);return d.push(getMonth(b)),d},getYearsBetween=function(){var a=new Date($("#d1").data("datepicker").date),b=$("#d2").data("datepicker").date;if(a.getTime()>b.getTime())return[];for(var c=b.getFullYear(),d=[];!_.isEqual(a.getFullYear(),c);)d.push(a.getFullYear()),a.setFullYear(a.getFullYear()+1);return d.push(c),d},getFiscalYear=function(a){var b=a.getFullYear(),c=new Date("July 1 "+b);return a.getTime()>=c.getTime()?b:b-1},getFiscalYearsBetween=function(){var a=new Date($("#d1").data("datepicker").date),b=$("#d2").data("datepicker").date;if(a.getTime()>b.getTime())return[];for(var c=getFiscalYear(b),d=[];!_.isEqual(getFiscalYear(a),c);)d.push(getFiscalYear(a)),a.setFullYear(a.getFullYear()+1);return d.push(c),d},getSemester=function(a){var b=a.getFullYear(),c=new Date("May 28 "+b);if(a.getTime()<c.getTime())return["Spring",b];var d=new Date("August 25 "+b);return a.getTime()<d.getTime()?["Summer",b]:["Fall",b]},increaseSemester=function(a){var b=a.getFullYear(),c=new Date("May 28 "+b);if(a.getTime()<c.getTime())return c;var d=new Date("August 25 "+b);return a.getTime()<d.getTime()?d:new Date("January 1 "+(b+1))},getSemestersBetween=function(){var a=new Date($("#d1").data("datepicker").date),b=$("#d2").data("datepicker").date;if(a.getTime()>b.getTime())return[];for(var c=getSemester(b),d=[];!_.isEqual(getSemester(a),c);)d.push(getSemester(a)),a=increaseSemester(a);return d.push(c),d},Event=Backbone.Model.extend({initialize:function(){this.set("reservedHour",(Date.parse(this.get("end"))-Date.parse(this.get("start")))/36e5),this.set("eventHour",(Date.parse(this.get("eventEnd"))-Date.parse(this.get("eventStart")))/36e5),this.set("shiftHour",this.get("shifts").reduce(function(a,b){return a+(Date.parse(b.end)-Date.parse(b.start))/36e5},0)),this.set("fullShiftNumber",fullShiftNumber(this.attributes)),this.set("inventoryNumber",this.get("inventory").reduce(function(a,b){return a+parseInt(b.amt)},0))}}),PageableEventList=Backbone.PageableCollection.extend({model:Event,state:{pageSize:10},updatePageSize:function(){this.state.pageSize=parseInt($("#pagination").val())},mode:"client",overview:function(){var a=this.fullCollection.toJSON(),b={all:a.length,cancelled:_.where(a,{cancelled:!0}).length,fullyStaffed:a.reduce(function(a,b){return a+(fullShiftNumber(b)===b.staffNeeded?1:0)},0),partiallyStaffed:a.reduce(function(a,b){return a+(fullShiftNumber(b)<b.staffNeeded&&fullShiftNumber(b)>0?1:0)},0),unstaffedEvents:a.reduce(function(a,b){return a+(0===fullShiftNumber(b)?1:0)},0),totalHours:a.reduce(function(a,b){return a+(Date.parse(b.end)-Date.parse(b.start))/36e5},0).toFixed(2),totalShiftHours:a.reduce(function(a,b){return a+b.shiftHour},0).toFixed(2),getCategoryNumber:function(b){return _.where(a,{category:b}).length},techMustStay:_.where(a,{techMustStay:!0}).length,video:_.where(a,{video:!0}).length,audio:_.where(a,{audio:!0}).length};this.data=b,$("#overview").html(_.template($("#overview-template").html(),{events:a,data:b}))},graphs:function(){var a=$("#graph-type").val().split(" - ");"Events"===a[0]?($("#graph-time").hide(),this.eventGraphs(a[1])):"Time"===a[0]?($("#graph-time").show(),this.timeGraphs(a[1],a[2])):console.error("No such graph exists"),$(".loading").hide()},eventGraphs:function(a){$(".graphs").html(_.template($("#event-graphs-template").html(),{}));var b={inGraphDataShow:!0,canvasBorders:!0,canvasBordersWidth:2,graphTitle:"Events by Category",graphTitleFontSize:16,legend:!0,rotateLabels:"smart",legendBordersSpaceBefore:0,legendBordersSpaceAfter:0,startAngle:0,animationSteps:20,animationEasing:"easeOutQuart"},c=this,d=function(){"Bar"===a&&(e={labels:e.map(function(a){return a.title}),datasets:[{data:e.map(function(a){return a.value}),fillColor:randomColor()}]})},e=["A","B","C"].map(function(a){return{value:c.data.getCategoryNumber(a),title:a,color:randomColor()}});d();new Chart(document.getElementById("chart1").getContext("2d"))[a](e,b);b.graphTitle="Events by Staffing",e=[{title:"Fully Staffed",value:c.data.fullyStaffed},{title:"Partially Staffed",value:c.data.partiallyStaffed},{title:"Unstaffed",value:c.data.unstaffedEvents},{title:"Cancelled",value:c.data.cancelled}].map(function(a){return a.color=randomColor(),a}),d();new Chart(document.getElementById("chart2").getContext("2d"))[a](e,b);b.graphTitle="Events by Staying",e=[{title:"Stay",value:c.data.techMustStay},{title:"Setup and Breakdown",value:c.data.all-c.data.techMustStay}].map(function(a){return a.color=randomColor(),a}),d();new Chart(document.getElementById("chart3").getContext("2d"))[a](e,b)},timeGraphs:function(a,b){$(".graphs").html(_.template($("#time-graphs-template").html(),{}));var c,d,e,f=this.fullCollection.toJSON(),g={bezierCurve:!1,inGraphDataShow:!0,canvasBorders:!0,canvasBordersWidth:2,graphTitleFontSize:16,legend:!0,rotateLabels:"smart",legendBordersSpaceBefore:0,legendBordersSpaceAfter:0,startAngle:0,animationSteps:20,animationEasing:"easeOutQuart"},h=getDaysBetween().map(function(a){return new Date(a)}),i=function(a){return f.filter(function(b){return new Date(b.start).toDateString()===a.toDateString()})},j=getWeeksBetween(),k=function(a){return f.filter(function(b){return _.isEqual(a,getWeek(new Date(b.start)))})},l=getMonthsBetween(),m=function(a){return f.filter(function(b){return _.isEqual(a,getMonth(new Date(b.start)))})},n=getYearsBetween(),o=function(a){return f.filter(function(b){return _.isEqual(a,new Date(b.start).getFullYear())})},p=getFiscalYearsBetween(),q=function(a){return f.filter(function(b){return _.isEqual(a,getFiscalYear(new Date(b.start)))})},r=getSemestersBetween(),s=function(a){return f.filter(function(b){return _.isEqual(a,getSemester(new Date(b.start)))})},t=$("#graph-time").val();switch(t){case"Days":c=h,d=i,e=h.map(function(a){return a.getMonth()+1+"/"+a.getDate()});break;case"Weeks":c=j,d=k,e=j.map(function(a){return ordinal(a[0])+" week, "+a[1]});break;case"Months":c=l,d=m;var u=["January","February","March","April","May","June","July","August","September","October","November","December"];e=l.map(function(a){return u[a[0]-1]+" "+a[1]});break;case"Years":c=n,d=o,e=n.map(String);break;case"Fiscal Years":c=p,d=q,e=p.map(String);break;case"Semesters":c=r,d=s,e=r.map(function(a){return a.join(" ")})}var v;"Category"===b?(g.graphTitle="Events by Category",v={labels:e,datasets:["A","B","C"].map(function(a){return{title:a,data:c.map(function(b){return _(d(b)).where({category:a}).length})}}).map(function(b){return b["Line"===a?"strokeColor":"fillColor"]=randomColor(),b["Bar"===a||"StackedBar"===a?"strokeColor":"fillColor"]="transparent",b})}):"Staffing"===b?(g.graphTitle="Events by Staffing",v={labels:e,datasets:[{title:"Fully Staffed",data:c.map(function(a){return d(a).reduce(function(a,b){return a+(fullShiftNumber(b)===b.staffNeeded?1:0)},0)})},{title:"Partially Staffed",data:c.map(function(a){return d(a).reduce(function(a,b){return a+(fullShiftNumber(b)<b.staffNeeded&&fullShiftNumber(b)>0?1:0)},0)})},{title:"Unstaffed",data:c.map(function(a){return d(a).reduce(function(a,b){return a+(0===fullShiftNumber(b)?1:0)},0)})},{title:"Cancelled",data:c.map(function(a){return _.where(d(a),{cancelled:!0}).length})}].map(function(b){return b["Line"===a?"strokeColor":"fillColor"]=randomColor(),b["Bar"===a||"StackedBar"===a?"strokeColor":"fillColor"]="transparent",b})}):console.error("No such graph choice exists");new Chart(document.getElementById("chart").getContext("2d"))[a](v,g)}}),columns=[{name:"",cell:"select-row",headerCell:"select-all",renderable:!0},{name:"title",label:"Title",cell:"string",editable:!1},{name:"category",label:"Category",cell:"string",editable:!1},{name:"loc",label:"Location",cell:"string",editable:!1},{name:"start",label:"Date",cell:"date",editable:!1},{name:"fullShiftNumber",label:"St. Assigned",cell:"integer",editable:!1},{name:"staffNeeded",label:"St. Needed",cell:"integer",editable:!1},{name:"reservedHour",label:"Reserved hr",cell:"number",editable:!1},{name:"eventHour",label:"Event hr",cell:"number",editable:!1},{name:"shiftHour",label:"Shift hr",cell:"number",editable:!1},{name:"inventoryNumber",label:"Inventory",cell:"integer",editable:!1},{name:"cancelled",label:"Cancelled",cell:"boolean",editable:!1},{name:"techMustStay",label:"Tech Stay",cell:"boolean",editable:!1},{name:"video",label:"Video",cell:"boolean",editable:!1},{name:"audio",label:"Audio",cell:"boolean",editable:!1}];$(document).ready(function(){var a=new Date;a.setHours(0,0,0,0);var b=new Date(a.getTime()-6048e5);$(".date").datepicker(),$("#d1").datepicker("setValue",b),$("#d2").datepicker("setValue",a),pageableEventList=new PageableEventList;var c=function(){$(".loading").show(),pageableEventList.url="/events?filter="+$("#filter").val()+"&start="+$("#d1").data("datepicker").date.getTime()/1e3+"&end="+$("#d2").data("datepicker").date.getTime()/1e3,pageableEventList.fetch({reset:!0,success:function(){pageableEventList.overview(),pageableEventList.graphs(),"undefined"==typeof done&&(done=!0,$("a:contains('Date')").trigger("click").trigger("click"))}})};$("#filter").change(c),$(".date").on("changeDate",c),$("#graph-type").change(function(){$(".loading").show({done:function(){pageableEventList.graphs()}})}),$("#graph-time").change(function(){$(".loading").show({done:function(){pageableEventList.graphs()}})}),$("#pagination").change(function(){pageableEventList.updatePageSize(),c()});var d=new Backgrid.Extension.Paginator({collection:pageableEventList}),e=new Backgrid.Grid({columns:columns,collection:pageableEventList});$stuff=$(".stuff"),$stuff.append(e.render().el),$stuff.after(d.render().el);var f=new Backgrid.Extension.ClientSideFilter({collection:pageableEventList,fields:["title","loc"]});$(".buttons").after(f.render().el),$(f.el).css({"float":"right",margin:"20px"});var g=[{id:"title",text:"Title"},{id:"category",text:"Category"},{id:"loc",text:"Location"},{id:"start",text:"Reserved Start Time"},{id:"end",text:"Reserved End Time"},{id:"reservedHour",text:"Reserved Length in Hours"},{id:"eventStart",text:"Event Start Time"},{id:"eventEnd",text:"Event End Time"},{id:"eventHour",text:"Event Length in Hours"},{id:"fullShiftNumber",text:"# of Assigned Staff"},{id:"shiftHour",text:"Total Hours of Shifts"},{id:"staffNeeded",text:"# of Needed Staff"},{id:"inventoryNumber",text:"# of Inventory Used"},{id:"cancelled",text:"Cancelled?"},{id:"video",text:"Video Event?"},{id:"audio",text:"Audio Event?"},{id:"techMustStay",text:"Tech Must Stay?"}];$("#fields").tags({only_suggestions:!0,suggestions:g,values:g}),$("#export button").click(function(){var a=$.makeArray($("#fields .pills-list .badge").map(function(){return $(this).data("tag-id")})),b=pageableEventList.fullCollection.toJSON(),c=b.map(function(b){return a.map(function(a){var c=b[a];return _(c).isUndefined()&&(c=!1),_(c).isNumber()?c:(_.contains(["start","end","eventStart","eventEnd"],a)&&(c=new Date(c).toLocaleString()),'"'+c.toString().replace(/"/g,'""')+'"')}).join(",")}),d=$.makeArray($("#fields .pills-list .badge").map(function(){return $(this).text()})),e=[d.map(function(a){return'"'+a.replace(/"/g,'""')+'"'}).join(",")].concat(c).join("\n");exportCSV(e)}),c()}),$(document).keydown(function(a){if($(event.target).is(":not(input, textarea)"))switch(a.keyCode){case 39:$('.backgrid-paginator a[title="Next"]').trigger("click");break;case 37:$('.backgrid-paginator a[title="Previous"]').trigger("click")}});