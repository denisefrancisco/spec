/*! Spec 0.1.4 */
var fullShiftNumber=function(a){return a.shifts.map(function(a){return a.staff}).filter(function(a){return a}).length},randomColor=function(){return"#"+Math.floor(16777215*Math.random()).toString(16)},getDaysBetween=function(){var a=new Date($("#d1").data("datepicker").date),b=$("#d2").data("datepicker").date;if(a.getTime()>b.getTime())return[];for(var c=[];a.toDateString()!==b.toDateString();)c.push(a.toDateString()),a.setDate(a.getDate()+1);return c},Event=Backbone.Model.extend({initialize:function(){this.set("shiftHour",this.get("shifts").reduce(function(a,b){return a+(Date.parse(b.end)-Date.parse(b.start))/36e5},0)),this.set("fullShiftNumber",fullShiftNumber(this.attributes))}}),PageableEventList=Backbone.PageableCollection.extend({model:Event,state:{pageSize:10},mode:"client",overview:function(){var a=this.fullCollection.toJSON(),b={all:a.length,cancelled:_.where(a,{cancelled:!0}).length,fullyStaffed:a.reduce(function(a,b){return a+(fullShiftNumber(b)===b.staffNeeded?1:0)},0),partiallyStaffed:a.reduce(function(a,b){return a+(fullShiftNumber(b)<b.staffNeeded&&fullShiftNumber(b)>0?1:0)},0),unstaffedEvents:a.reduce(function(a,b){return a+(0===fullShiftNumber(b)?1:0)},0),totalHours:a.reduce(function(a,b){return a+(Date.parse(b.end)-Date.parse(b.start))/36e5},0).toFixed(2),totalShiftHours:a.reduce(function(a,b){return a+b.shiftHour},0).toFixed(2),getCategoryNumber:function(b){return _.where(a,{category:b}).length},techMustStay:_.where(a,{techMustStay:!0}).length,video:_.where(a,{video:!0}).length,audio:_.where(a,{audio:!0}).length};this.data=b,$("#overview").html(_.template($("#overview-template").html(),{events:a,data:b}))},graphs:function(){var a=$("#graph-type").val().split(" - ");"Events"===a[0]?this.eventGraphs(a[1]):"Time"===a[0]?this.timeGraphs(a[1],a[2]):console.error("No such graph exists")},eventGraphs:function(a){$(".graphs").html(_.template($("#event-graphs-template").html(),{}));var b={inGraphDataShow:!0,canvasBorders:!0,canvasBordersWidth:2,graphTitle:"Events by Category",graphTitleFontSize:16,legend:!0,rotateLabels:"smart",legendBordersSpaceBefore:0,legendBordersSpaceAfter:0,startAngle:0,animationSteps:20,animationEasing:"easeOutQuart"},c=this,d=function(){"Bar"===a&&(e={labels:e.map(function(a){return a.title}),datasets:[{data:e.map(function(a){return a.value}),fillColor:randomColor()}]})},e=["A","B","C"].map(function(a){return{value:c.data.getCategoryNumber(a),title:a,color:randomColor()}});d();new Chart(document.getElementById("chart1").getContext("2d"))[a](e,b);b.graphTitle="Events by Staffing",e=[{title:"Fully Staffed",value:c.data.fullyStaffed},{title:"Partially Staffed",value:c.data.partiallyStaffed},{title:"Unstaffed",value:c.data.unstaffedEvents},{title:"Cancelled",value:c.data.cancelled}].map(function(a){return a.color=randomColor(),a}),d();new Chart(document.getElementById("chart2").getContext("2d"))[a](e,b);b.graphTitle="Events by Staying",e=[{title:"Stay",value:c.data.techMustStay},{title:"Setup and Breakdown",value:c.data.all-c.data.techMustStay}].map(function(a){return a.color=randomColor(),a}),d();new Chart(document.getElementById("chart3").getContext("2d"))[a](e,b)},timeGraphs:function(a,b){console.log(arguments),$(".graphs").html(_.template($("#time-graphs-template").html(),{}));var c,d=this.fullCollection.toJSON(),e={bezierCurve:!1,inGraphDataShow:!0,canvasBorders:!0,canvasBordersWidth:2,graphTitleFontSize:16,legend:!0,rotateLabels:"smart",legendBordersSpaceBefore:0,legendBordersSpaceAfter:0,startAngle:0,animationSteps:20,animationEasing:"easeOutQuart"},f=getDaysBetween().map(function(a){return new Date(a)}),g=function(a){return d.filter(function(b){return console.log(b),new Date(b.start).toDateString()===a.toDateString()})};"Category"===b?(e.graphTitle="Events by Category",c={labels:f.map(function(a){return a.getMonth()+1+"/"+a.getDate()}),datasets:["A","B","C"].map(function(a){return{title:a,data:f.map(function(b){return _(g(b)).where({category:a}).length})}}).map(function(b){return b["Line"===a?"strokeColor":"fillColor"]=randomColor(),b["Bar"===a?"strokeColor":"fillColor"]="transparent",b})}):"Staffing"===b?(e.graphTitle="Events by Staffing",c={labels:f.map(function(a){return a.getMonth()+1+"/"+a.getDate()}),datasets:[{title:"Fully Staffed",data:f.map(function(a){return g(a).reduce(function(a,b){return a+(fullShiftNumber(b)===b.staffNeeded?1:0)},0)})},{title:"Partially Staffed",data:f.map(function(a){return g(a).reduce(function(a,b){return a+(fullShiftNumber(b)<b.staffNeeded&&fullShiftNumber(b)>0?1:0)},0)})},{title:"Unstaffed",data:f.map(function(a){return g(a).reduce(function(a,b){return a+(0===fullShiftNumber(b)?1:0)},0)})},{title:"Cancelled",data:f.map(function(a){return _.where(g(a),{cancelled:!0}).length})}].map(function(b){return b["Line"===a?"strokeColor":"fillColor"]=randomColor(),b["Bar"===a?"strokeColor":"fillColor"]="transparent",b})}):console.error("No such graph choice exists");new Chart(document.getElementById("chart").getContext("2d"))[a](c,e)}}),InventoryCell=Backgrid.Cell.extend({render:function(){return this.$el.html(this.model.get("inventory").reduce(function(a,b){return a+parseInt(b.amt)},0)),this}}),columns=[{name:"",cell:"select-row",headerCell:"select-all",renderable:!0},{name:"title",label:"Title",cell:"string",editable:!1},{name:"category",label:"Category",cell:"string",editable:!1},{name:"loc",label:"Location",cell:"string",editable:!1},{name:"start",label:"Date",cell:"date",editable:!1},{name:"fullShiftNumber",label:"Staff Assigned",cell:"integer",editable:!1},{name:"staffNeeded",label:"Staff Needed",cell:"integer",editable:!1},{name:"shiftHour",label:"Shift Hour",cell:"number",editable:!1},{name:"inventory",label:"Inventory",cell:InventoryCell,editable:!1},{name:"cancelled",label:"Cancelled",cell:"boolean",editable:!1},{name:"techMustStay",label:"Tech Must Stay",cell:"boolean",editable:!1},{name:"video",label:"Video",cell:"boolean",editable:!1},{name:"audio",label:"Audio",cell:"boolean",editable:!1}];$(document).ready(function(){var a=new Date;a.setHours(0,0,0,0);var b=new Date(a.getTime()-6048e5);$(".date").datepicker(),$("#d1").datepicker("setValue",b),$("#d2").datepicker("setValue",a),pageableEventList=new PageableEventList;var c=function(){pageableEventList.url="/events?filter="+$("#filter").val()+"&start="+$("#d1").data("datepicker").date.getTime()/1e3+"&end="+$("#d2").data("datepicker").date.getTime()/1e3,pageableEventList.fetch({reset:!0,success:function(){pageableEventList.overview(),pageableEventList.graphs(),"undefined"==typeof done&&(done=!0,$("a:contains('Date')").trigger("click").trigger("click"))}})};$("#filter").change(c),$(".date").on("changeDate",c),$("#graph-type").change(function(){pageableEventList.graphs()});var d=new Backgrid.Extension.Paginator({collection:pageableEventList}),e=new Backgrid.Grid({columns:columns,collection:pageableEventList});$stuff=$(".stuff"),$stuff.append(e.render().el),$stuff.after(d.render().el);var f=new Backgrid.Extension.ClientSideFilter({collection:pageableEventList,fields:["title","loc"]});$(".buttons").after(f.render().el),$(f.el).css({"float":"right",margin:"20px"}),c()}),$(document).keydown(function(a){if($(event.target).is(":not(input, textarea)"))switch(a.keyCode){case 39:$('.backgrid-paginator a[title="Next"]').trigger("click");break;case 37:$('.backgrid-paginator a[title="Previous"]').trigger("click")}});