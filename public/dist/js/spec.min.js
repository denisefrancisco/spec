/*! Spec 0.1.5 */
jQuery(function(a){a.fn.editable.defaults.mode="inline";var Spec={},b=function(a){return a.shifts.map(function(a){return a.staff}).filter(function(a){return a}).length},c=function(b,c){return _.isUndefined(c)&&(c=!1),symbol="",b.onHold===!0&&(symbol+='<i class="icon-ban-circle"></i> '),b.video===!0&&(symbol+='<i class="icon-facetime-video"></i> '),b.audio===!0&&(symbol+='<i class="icon-volume-up"></i> '),symbol=a(a.parseHTML(symbol)),symbol.siblings("i").addClass(c?"icon-white":""),symbol},d=function(){a("#popup").modalPopover("hide"),a("#eventButton").addClass("disabled")},e=function(){a(".timeline").remove();var b=a(".fc-agenda-slots:visible").parent(),c=a("<hr>").addClass("timeline");b.prepend(c);var d=new Date,e=a("#calendar").fullCalendar("getView");if(!(e.intervalStart.toDate()<d&&e.intervalEnd.toDate()>d))return void c.hide();c.show();var f=60*d.getHours()*60+60*d.getMinutes()+d.getSeconds(),g=f/86400,h=Math.floor(b.height()*g);if(c.css("top",h+"px"),"agendaWeek"===e.name){var i=a(".fc-today:visible"),j=i.position().left+1,k=i.width()-2;c.css({left:j+"px",width:k+"px"})}},f=Backbone.Model.extend({idAttribute:"_id",initialize:function(){this.on({change:this.updateClientEvent})},fcEvent:function(){var a=_.first(A.$el.fullCalendar("clientEvents",this.get("_id")));if(_.isUndefined(a))throw console.log(this),new Error("No such FullCalendar event");return a},updateClientEvent:function(a){return _.isUndefined(a)?!1:(fcEvent=_.extend(a.fcEvent(),a.changed),A.$el.fullCalendar("updateEvent",fcEvent),void a.save(a.changed,{patch:!0}))}}),g=Backbone.Collection.extend({initialize:function(a){this.filter=a.filter,""===this.filter&&(this.filter="hideCancelled")},model:f,url:"/events",getNewEvents:function(a,b,c){this.fetch({data:{start:a.unix(),end:b.unix(),filter:this.filter},success:function(a,b){c(b)}})}}),h=Backbone.View.extend({initialize:function(){this.render()},render:function(){var b=this;return a("#popup").modalPopover({target:"#eventButton",placement:"bottom",backdrop:!1}),this.$el.fullCalendar({header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},timezone:"local",lazyFetching:!0,allDaySlot:!1,defaultView:"agendaWeek",windowResize:function(){b.adjustSize()},viewRender:e,events:function(a,c,d,e){b.collection.getNewEvents(a,c,e)},eventRender:function(a,c,d){(_.isUndefined(a.gCal)||a.gCal!==!0)&&new i({model:b.collection.findWhere({_id:a._id}),event:a,el:c,view:d})}}),this.adjustSize(),a("#leftGroup").detach().prependTo(".fc-header-left"),a("#rightGroup").detach().appendTo(".fc-header-right"),a(document).keydown(function(c){if(a(event.target).is(":not(input, textarea)"))switch(c.keyCode){case 39:d(),b.$el.fullCalendar("next");break;case 37:d(),b.$el.fullCalendar("prev");break;case 38:d(),b.$el.fullCalendar("today")}}),setInterval(e(),3e5),this},adjustSize:function(){var b=a(window).height()-a(".fc-header").height()/2;this.$el.fullCalendar("option","height",b),a("#modifyCSSRule").html(".fc-view-month { height:"+(b-70)+"px !important;  }")},events:{"click .fc-widget-content":"onEmptyAreaClick"},onEmptyAreaClick:function(){d()}}),i=Backbone.View.extend({initialize:function(){this.event=this.model.attributes,this.render()},render:function(){return this.addBackgroundClasses(),this.backBoxes(),this.$el.find(".fc-event-title").prepend(c(this.event,!0)),this.staffTooltip(),this.$el.contextmenu({target:"#context-menu"}),this},addBackgroundClasses:function(){var a=b(this.event);this.event.techMustStay===!1&&this.$el.addClass("setupAndBreakdown"),this.event.cancelled===!0?this.$el.addClass("fc-cancelled"):0===a?this.$el.addClass("fc-unstaffed"):a<this.event.staffNeeded?this.$el.addClass("fc-partially"):a===this.event.staffNeeded&&this.$el.addClass("fc-staffed");var c=!1;this.event.shifts.forEach(function(a){_(a.confirmed).isUndefined()||a.confirmed||(c=!0)}),c&&this.$el.addClass("unconfirmed")},backBoxes:function(){var a=Date.parse(this.event.start),b=Date.parse(this.event.end),c=0,d=0;if("undefined"!=typeof this.event.eventStart&&"undefined"!=typeof this.event.eventEnd){var e=Date.parse(this.event.eventStart),f=Date.parse(this.event.eventEnd);c=(a-e)/(a-b)*100,d=(f-b)/(a-b)*100}this.$el.find(".fc-event-bg").append("<div class='event-bg-section' style='height:"+c+"%'></div>").append("<div style='height:"+(100-c-d)+"%'></div>").append("<div class='event-bg-section' style='height:"+d+"%'></div></div>")},staffTooltip:function(){var a=this.event.shifts.map(function(a){var b="";return _(a.confirmed).isUndefined()||a.confirmed||(b="(?)"),a.staff+b}).filter(function(a){return a});a.length>0&&this.$el.tooltip({title:"Staff: "+a.join(", ")})},events:{click:"onClick",contextmenu:"onRightClick"},onClick:function(){new k({model:this.model,el:a("#popup")})},onRightClick:function(){return this.onClick(),Spec.permission<10?!1:void new m({model:this.model,el:a("#context-menu")})}}),j=[!1,!1],k=Backbone.View.extend({initialize:function(){var a=this;this.model.on("change",function(){a.renderContent()}),this.render()},render:function(){d(),this.renderContent(),this.$el.modalPopover("show"),a("#eventButton").removeClass("disabled")},renderContent:function(){var d=this;this.$el.undelegate();var e=c(this.model.attributes).clone().wrap("<p>").parent().html(),f=_.template(a("#modal-popover-template").html(),{event:this.model.attributes,staffColor:this.staffColor(),shiftNumber:b(this.model.attributes),icons:e,collapse:j,Spec:Spec});this.$el.html(f);var g=this.model.attributes.inventory.map(function(a){var b=parseInt(a.item);return{amt:parseInt(a.amt),id:b.toString(),text:y.getText(b)}});this.$el.find("#inventory").tags({values:g,only_suggestions:!0,suggestions:y.toJSON(),onRemove:function(a){{var b=parseInt(a.data("tag-id"));d.model.get("inventory").filter(function(a){return b!==a.id})}d.model.set("inventory".setTo)},onDuplicate:function(a,b){var c=d.model.get("inventory").map(function(a){return parseInt(a.item)===parseInt(b.id)&&a.amt++,a});d.model.set("inventory",c),d.model.save({inventory:c},{patch:!0}),d.model.trigger("change",d.model)},onBeforeAdd:function(b,c){return c.amt||(c.amt=1),b=a(b),b.contents().first().before('<input class="tag-amt" type="number" value="'+c.amt+'" min="1">'),b.find("input").change(function(){var b=parseInt(a(this).val()),e=d.model.get("inventory").map(function(a){return parseInt(a.item)===parseInt(c.id)&&(a.amt=b),a});d.model.set("inventory",e),d.model.save({inventory:e},{patch:!0}),d.model.trigger("change",d.model)}),b},onBeforeNewAdd:function(a,b){var c={amt:1,item:b.id.toString()};d.model.set("inventory",d.model.get("inventory").concat(c))}}),a("#collapseTwo").on("click shown keydown",function(){a(this).css("overflow","visible")}).on("hide",function(){a(this).css("overflow","hidden")})},staffColor:function(){var a=this.model.attributes,c=b(a);return a.cancelled===!0?"btn-inverse":0===c?"btn-danger":c<a.staffNeeded?"btn-warning":c===a.staffNeeded?"btn-success":c>a.staffNeeded?"btn-info":""},events:{'click a[data-task="staff"]':"staffEvent",'click button[data-task="addNote"]':"addNote","click .removeNote":"removeNote",'click a[href="#collapseOne"]':"notesCollapse",'click a[href="#collapseTwo"]':"inventoryCollapse"},notesCollapse:function(){j[0]=!j[0]},inventoryCollapse:function(){j[1]=!j[1]},staffEvent:function(){new o({model:this.model,el:a("#staff-modal")})},addNote:function(){return new l({model:this.model,el:a("#add-note-modal")}),!1},removeNote:function(b){var c=a(b.currentTarget).data("id"),d=this.model.get("notes").filter(function(a){return a.id!==c});this.model.set("notes",d)}}),l=Backbone.View.extend({initialize:function(){this.render()},render:function(){var b=_.template(a("#add-note-template").html(),{});return this.$el.html(b),this.$el.modal("show"),this},events:{"click .btn-primary":"add",hide:"onClose"},add:function(){var a=this.$el.find("textarea").val(),b={text:a,date:new Date,user:Spec.username};this.model.set("notes",this.model.get("notes").concat(b)),this.$el.modal("hide")},onClose:function(){this.undelegateEvents()}}),m=Backbone.View.extend({initialize:function(){this.$el.undelegate(),this.render()},render:function(){this.$el.find("ul").html(_.template(a("#context-menu-template").html(),{event:this.model.attributes}))},events:{'click a[data-task="staff"]':"staffEvent",'click a[data-task="duration"]':"toggleDuration",'click a[data-task="video"]':"toggleVideo",'click a[data-task="audio"]':"toggleAudio",'click a[data-task="edit"]':"editEvent",'click a[data-task="cancel"]':"toggleCancel",'click a[data-task="remove"]':"removeEvent"},staffEvent:function(){new o({model:this.model,el:a("#staff-modal")})},toggleDuration:function(){this.model.set("techMustStay",!this.model.get("techMustStay"))},toggleVideo:function(){this.model.set("video",!this.model.get("video"))},toggleAudio:function(){this.model.set("audio",!this.model.get("audio"))},editEvent:function(){new q({model:this.model,el:a("#edit-modal")})},toggleCancel:function(){this.model.set("cancelled",!this.model.get("cancelled"))},removeEvent:function(){new n({model:this.model,el:a("#remove-modal")})}}),n=Backbone.View.extend({initialize:function(){this.render()},render:function(){var b=_.template(a("#remove-template").html(),{event:this.model.attributes});this.$el.html(b),this.$el.modal("show")},events:{"click .btn-danger":"remove",hide:"close"},remove:function(){A.$el.fullCalendar("removeEvents",this.model.get("_id")),this.model.destroy(),this.close()},close:function(){this.$el.undelegate()}}),o=Backbone.View.extend({initialize:function(a){var b=this;this.render(),this.staffView=new p(a),this.model.on("change:shifts",function(){console.log("changed"),b.staffView.clean(),b.staffView=new p(a)})},render:function(){return this.$el.modal("show"),this},events:{hide:"onClose"},onClose:function(b){a(b.target).is(b.currentTarget)&&(this.staffView.clean(),this.undelegateEvents())}}),p=Backbone.View.extend({clean:function(){this.remove()},initialize:function(a){this.options=a,this.render()},render:function(){return this.$el.find(".modal-body").html(a("<div/>",{id:"staff-el"})),this.$el=this.$el.find("#staff-el"),this.renderModalContent(),this},renderModalContent:function(){var b=this.model.fcEvent();b.shifts=this.model.get("shifts");var c=b.shifts.reduce(function(a,b){return a&&_.has(b,"id")},!0);if(c){var d=this,e=_.template(a("#staff-template").html(),{event:b});this.$el.html(e),this.$el.find(".spinner").spinner(),this.$el.find(".coverShift").tooltip({title:"Sent a tech from the office",placement:"left"}),this.$el.find("#shift-start").timepicker({defaultTime:this.model.fcEvent().start.format("h:mm A")}),this.$el.find("#shift-end").timepicker({defaultTime:this.model.fcEvent().end.format("h:mm A")}),this.$el.find(".bootstrap-timepicker input").on("show.timepicker",function(){a(this).prev().toggle()}),x.each(function(b){d.$el.find(".combobox").append(a("<option>",{value:b.get("username")}).text(b.get("name")+" ("+b.get("username")+")"))}),a(".combobox").combobox({placeholder:"Choose a staff"})}},events:{"changed .spinner":"staffNeededUpdate","click #addNewShift":"addNewShift","click .removeShift":"removeShift","click .coverShift":"coverShift","click .shiftWithdraw":"shiftWithdraw","click .shiftSignUp":"shiftSignUp"},onClose:function(){this.undelegateEvents()},staffNeededUpdate:function(a,b){b!==this.model.get("staffNeeded")&&this.model.set("staffNeeded",b)},addNewShift:function(){var b=this.$el.find("#staffInput").val(),c=this.model.fcEvent(),d=moment(new Date(c.start.format("MMM D YYYY ")+a("#shift-start").val())),e=moment(new Date(c.end.format("MMM D YYYY ")+a("#shift-end").val()));e.isBefore(d)&&e.add("d",1);var f={staff:b,start:d.toDate(),end:e.toDate()};this.model.set("shifts",this.model.get("shifts").concat(f))},removeShift:function(b){var c=a(b.currentTarget).data("id"),d=this.model.get("shifts").filter(function(a){return a.id!==c});this.model.set("shifts",d)},coverShift:function(b){var c=a(b.currentTarget).data("id"),d=!a(b.currentTarget).hasClass("active"),e=_(this.model.get("shifts")).clone().map(function(a){return a.id===c&&(a.cover=d),a});this.model.set("shifts",e),this.model.save({shifts:e},{patch:!0}),this.model.trigger("change:shifts")},shiftWithdraw:function(b){var c=a(b.currentTarget).data("id"),d=_(this.model.get("shifts")).clone().map(function(a){return a.id===c&&(a.staff=""),a});this.model.set("shifts",d),this.model.save({shifts:d},{patch:!0}),this.model.trigger("change:shifts"),this.model.trigger("change",this.model)},shiftSignUp:function(b){var c=a(b.currentTarget).data("id"),d=_(this.model.get("shifts")).clone().map(function(a){return a.id===c&&(a.staff=Spec.username),a});this.model.set("shifts",d),this.model.save({shifts:d},{patch:!0}),this.model.trigger("change:shifts"),this.model.trigger("change",this.model)}}),q=Backbone.View.extend({initialize:function(){return Spec.permission<10?!1:(this.changed={},void this.render())},render:function(){var b=this;this.$el.html(_.template(a("#edit-template").html(),{event:this.model.attributes})),a("#title").editable(),a("#desc").editable({title:"Description",rows:4}),a("#loc").editable(),a("#startDate").editable({format:"yyyy-mm-dd",viewformat:"mm/dd/yyyy",datepicker:{weekStart:1}}),a(".bootstrap-timepicker input").timepicker({}),a(".bootstrap-timepicker input").on("show.timepicker",function(){a(this).prev().toggle()}),a("#editSpinner").spinner(),a(".x-edit-event").on("save",function(a,c){b.changed[this.id]=c.newValue}),this.$el.modal("show")},events:{"click .modal-footer .btn-primary":"submit",hide:"close"},submit:function(){console.log(this.changed);var b=a.trim(a("#startDate").text());this.changed.staffNeeded=parseInt(a("#editSpinner input").val()),this.changed.start=moment(new Date(b+" "+a("#timepickerResStart").val())).toDate(),this.changed.eventStart=moment(new Date(b+" "+a("#timepickerEventStart").val())).toDate(),this.changed.end=moment(new Date(b+" "+a("#timepickerResEnd").val())),this.changed.eventEnd=moment(new Date(b+" "+a("#timepickerEventEnd").val())),this.changed.end=this.changed.end.add("d",this.changed.end.isBefore(this.changed.start)?1:0).toDate(),this.changed.eventEnd=this.changed.eventEnd.add("d",this.changed.eventEnd.isBefore(this.changed.eventStart)?1:0).toDate(),this.model.set(this.changed),this.model.trigger("change"),this.close()},close:function(){this.$el.undelegate()}}),r=Backbone.Model.extend({}),s=Backbone.Collection.extend({model:r,url:"staff/all",initialize:function(){this.fetch()}}),t=Backbone.Model.extend({}),u=Backbone.Collection.extend({model:t,url:"inventory/all",initialize:function(){this.fetch()},getText:function(a){var b=this.findWhere({id:parseInt(a)});if(_.isUndefined(b))throw new Error("No such inventory item exists.");return b.get("text")}}),v=Backbone.Router.extend({routes:{"*filter":"all"}}),w=new v;Backbone.history.start();var x=new s,y=new u,z=new g({filter:Backbone.history.fragment}),A=new h({el:a("#calendar"),collection:z});w.on("route:all",function(b){a("a").removeClass("drop-active"),a('a[href="#'+Backbone.history.fragment+'"]').addClass("drop-active"),(_.isNull(b)||_.isUndefined(b))&&w.navigate("hideCancelled",{trigger:!0}),z.filter=b,A.$el.fullCalendar("refetchEvents")}),a.ajax({url:"user/"}).done(function(a){Spec.username=a.username,Spec.permission=a.permission}),a("#gCalButton").click(function(){a(this).hasClass("active")?A.$el.fullCalendar("removeEventSource","gCalEvents/"):A.$el.fullCalendar("addEventSource","gCalEvents/"),a(this).toggleClass("active")}),a(document).ajaxStart(function(){a("#eventButton i").removeClass("icon-book"),a("#eventButton i").addClass("icon-refresh")}),a(document).ajaxStop(function(){a("#eventButton i").removeClass("icon-refresh"),a("#eventButton i").addClass("icon-book")}),a("#eventButton").click(function(){d()}),a(document).ajaxError(function(a,b,c){console.log(c.url),c.url.indexOf("gCalEvents")>-1&&(window.location.href="authorize/")})});