/*! spec 0.1.2 10-03-2014 */
!function(){var Spec={};Spec={storeAllStaff:[],username:"",permission:0,lastClickedEvent:{},View:{},filter:"",defaultFilter:"hideCancelled",updateUser:function(){$.ajax({type:"GET",url:"user/"}).done(function(info){Spec.username=info.username,Spec.permission=info.permission})},dropdownActiveFix:function(){$("a").removeClass("drop-active"),$('a[href="#'+Backbone.history.fragment+'"]').addClass("drop-active")},fullShiftNumber:function(event){return event.shifts.map(function(s){return s.staff}).filter(function(n){return n}).length},changePopupColor:function(event){$("#popupTitleButton").removeClass("btn-success btn-inverse btn-warning btn-danger btn-info");var shiftNumber=Spec.fullShiftNumber(event);1==event.cancelled?$("#popupTitleButton").addClass("btn-inverse"):0==shiftNumber?$("#popupTitleButton").addClass("btn-danger"):shiftNumber<event.staffNeeded?$("#popupTitleButton").addClass("btn-warning"):shiftNumber==event.staffNeeded?$("#popupTitleButton").addClass("btn-success"):shiftNumber>event.staffNeeded&&$("#popupTitleButton").addClass("btn-info"),$("#popupStaffInfo").html(shiftNumber+"/"+event.staffNeeded)},resizeMap:function(){var height=$(window).height()-40;$("#calendar").fullCalendar("option","height",height),$("#modifyCSSRule").html(".fc-view-month { height:"+(height-70)+"px !important; }")},setTimeline:function(){var parentDiv=jQuery(".fc-agenda-slots:visible").parent(),timeline=parentDiv.children(".timeline");0==timeline.length&&(timeline=jQuery("<hr>").addClass("timeline"),parentDiv.prepend(timeline));var curTime=new Date,curCalView=jQuery("#calendar").fullCalendar("getView");if(!(curCalView.visStart<curTime&&curCalView.visEnd>curTime))return void timeline.hide();timeline.show();var curSeconds=60*curTime.getHours()*60+60*curTime.getMinutes()+curTime.getSeconds(),percentOfDay=curSeconds/86400,topLoc=Math.floor(parentDiv.height()*percentOfDay);if(timeline.css("top",topLoc+"px"),"agendaWeek"==curCalView.name){var dayCol=jQuery(".fc-today:visible"),left=dayCol.position().left+1,width=dayCol.width()-2;timeline.css({left:left+"px",width:width+"px"})}},updateTimeline:function(){setInterval(function(){$(".timeline").remove(),Spec.setTimeline()},3e5)},formatAMPM:function(date){var hours=date.getHours(),minutes=date.getMinutes(),ampm=hours>=12?"PM":"AM";hours%=12,hours=hours?hours:12,minutes=10>minutes?"0"+minutes:minutes;var strTime=hours+":"+minutes+" "+ampm;return strTime},getFormattedDate:function(date){var year=date.getFullYear(),month=(1+date.getMonth()).toString();month=month.length>1?month:"0"+month;var day=date.getDate().toString();return day=day.length>1?day:"0"+day,month+"/"+day+"/"+year},_inventoryProto:{only_suggestions:!0,suggestion_url:"inventory/all",onRemove:function(pill){var id=pill.data("tag-id");$.ajax({type:"POST",url:"inventory/remove",data:{eventid:Spec.lastClickedEvent._id,inventoryid:pill.data("tag-id")}}).done(function(){console.log("pill with ID "+id+" removed"),Spec.setInventoryNumber(-1)})},onBeforeAdd:function(pill){return Spec.setInventoryNumber(1),pill},onBeforeNewAdd:function(pill){var id=pill.data("tag-id");return $.ajax({type:"POST",url:"inventory/add",data:{eventid:Spec.lastClickedEvent._id,inventoryid:pill.data("tag-id")}}).done(function(){console.log("pill with ID "+id+" added"),Spec.setInventoryNumber(1)}),pill}},decodeEntities:function(s){var str,temp=document.createElement("p");return temp.innerHTML=s,str=temp.textContent||temp.innerText,temp=null,str},generateEventSource:function(){var result={url:"events/?filter="+Spec.filter,ignoreTimezone:!1};return Spec.lastEventSource=result,result},gCalEventSource:{url:"gCalEvents/",ignoreTimezone:!1},boolGCal:!1,toggleGCalEvents:function(){Spec.boolGCal===!1?$("#calendar").fullCalendar("addEventSource",Spec.gCalEventSource):$("#calendar").fullCalendar("removeEventSource",Spec.gCalEventSource),Spec.boolGCal=!Spec.boolGCal},refetchEvents:function(){$("#calendar").fullCalendar("removeEventSource",Spec.lastEventSource),$("#calendar").fullCalendar("changeView","month"),$("#calendar").fullCalendar("addEventSource",Spec.generateEventSource()),$("#calendar").fullCalendar("changeView","agendaWeek")},techTemplateUpdate:function(){$("#technician").html(Spec.lastClickedEvent.techMustStay===!1?"<b>setup and breakdown</b> only.":"<b>duration of event</b>.")},setNoteNumber:function(addition,int){$("#noNote").text("undefined"==typeof int?parseInt($("#noNote").text())+addition:int)},setInventoryNumber:function(addition,int){$("#noInventory").text("undefined"==typeof int?parseInt($("#noInventory").text())+addition:int)}};var AppRouter=Backbone.Router.extend({routes:{printToday:"printToday","*filter":"all"}});Spec.app=new AppRouter,Spec.app.on("route:printToday",function(){console.log("printToday")}),Spec.app.on("route:all",function(filter){Spec.dropdownActiveFix(),null==filter?Spec.app.navigate(Spec.defaultFilter,{trigger:!0}):Spec.filter=filter,Spec.refetchEvents(),console.log(filter)}),Backbone.history.start(),_.templateSettings.variable="op",$.fn.editable.defaults.mode="inline",Spec.View.Edit=Backbone.View.extend({initialize:function(){this.render(),Spec.storeEdited={},$("#title").editable(),$("#desc").editable({title:"Description",rows:4}),$("#loc").editable(),$("#startDate").editable({format:"yyyy-mm-dd",viewformat:"mm/dd/yyyy",datepicker:{weekStart:1}}),$(".bootstrap-timepicker input").timepicker({}),$(".bootstrap-timepicker input").on("show.timepicker",function(){$(this).prev().toggle()}),$("#editSpinner").spinner(),$(".x-edit-event").on("save",function(e,params){var result={};result[this.id]=params.newValue,$.extend(Spec.storeEdited,result)})},render:function(){var variables={event:Spec.lastClickedEvent},template=_.template($("#edit_template").html(),variables);$("#editEvent .modal-body").html(template)}}),Spec.View.Remove=Backbone.View.extend({initialize:function(){this.render()},render:function(){var variables={event:Spec.lastClickedEvent},template=_.template($("#remove_template").html(),variables);$("#removeEvent").html(template)}}),Spec.View.Notes=Backbone.View.extend({initialize:function(options){Spec.setNoteNumber(0,0),this.render(options),options.notes.forEach(function(note){new Spec.View.EachNote(note)})},render:function(options){var variables={eventid:Spec.lastClickedEvent._id,notes:options.notes},template=_.template($("#notes_template").html(),variables);$("#notes").html(template)}}),Spec.View.EachNote=Backbone.View.extend({initialize:function(note){Spec.setNoteNumber(1),this.render(note)},render:function(note){var variables={eventid:Spec.lastClickedEvent._id,note:note},template=_.template($("#each_note_template").html(),variables);$("#notesBody").append(template)}}),Spec.View.Staff=Backbone.View.extend({initialize:function(options){this.render(options)},render:function(options){var variables={shifts:options.shifts},template=_.template($("#staff_template").html(),variables);$("#staffEvent .modal-body").html(template),Spec.techTemplateUpdate(),options.shifts.forEach(function(shift){new Spec.View.EachStaff({item:shift})}),Spec.newRowInit(options.shifts.slice(-1)[0]),$(".combobox").combobox({placeholder:"Choose a staff"}),$("#staffSpinner").spinner(),$("#staffSpinner").on("changed",function(e,val){$.ajax({type:"POST",url:"event/spinner",data:{eventid:Spec.lastClickedEvent._id,make:val}}).done(function(){Spec.refetchEvents(),Spec.lastClickedEvent.staffNeeded=parseInt(val),Spec.changePopupColor(Spec.lastClickedEvent),console.log("event with ID "+Spec.lastClickedEvent._id+" staff number changed to "+val)})})}}),Spec.View.EachStaff=Backbone.View.extend({initialize:function(options){this.render(options)},render:function(options){var variables={item:options.item},template=_.template($("#each_staff_template").html(),variables);$("#staffEvent .modal-body tbody").prepend(template)}}),Spec.newRowInit=function(lastShift){if(void 0==lastShift)var startTime=Spec.formatAMPM(Spec.lastClickedEvent.start),endTime=Spec.formatAMPM(Spec.lastClickedEvent.end);else var startTime=Spec.formatAMPM(new Date(Date.parse(lastShift.start))),endTime=Spec.formatAMPM(new Date(Date.parse(lastShift.end)));$("#timepicker5").timepicker({defaultTime:startTime}),$("#timepicker6").timepicker({defaultTime:endTime}),$(".bootstrap-timepicker input").on("show.timepicker",function(){$(this).prev().toggle()}),$(".combobox").html(""),Spec.storeAllStaff.forEach(function(person){0!=person.name&&$(".combobox").append($("<option>",{value:person.username}).text(person.name+" ("+person.username+")"))})},$(document).ready(function(){{var date=new Date;date.getDate(),date.getMonth(),date.getFullYear()}$("#popup").modalPopover({target:"#eventButton",placement:"bottom",backdrop:!1}),$("#calendar").fullCalendar({header:{left:"prevYear,prev,next,nextYear today",center:"title",right:"month,agendaWeek,agendaDay"},editable:!1,allDaySlot:!1,allDayDefault:!1,firstDay:date.getDay(),eventBorderColor:"black",windowResize:function(){Spec.resizeMap()},eventClick:function(calEvent){if(calEvent.gCal===!0)return!1;Spec.lastClickedEvent=calEvent,$("#popup").modalPopover("hide"),symbol="",1==calEvent.video&&(symbol+='<i class="icon-facetime-video"></i> '),1==calEvent.audio&&(symbol+='<i class="icon-volume-up"></i> '),$("#eventButton").removeClass("disabled"),Spec.changePopupColor(calEvent),$("#popupTitle").html(symbol+Spec.decodeEntities(calEvent.title));var inside;inside=_.isObject(calEvent.desc)?"":Spec.decodeEntities(calEvent.desc),$("#popupContentInside").html(inside);try{$("#popupContentHeader").html("<b>"+defaults.dayNames[calEvent.start.getDay()]+" | "+Spec.decodeEntities(calEvent.loc)+'</b><br><i class="icon-time"></i> <b>'+Spec.formatAMPM(calEvent.start)+"</b>  <i>"+Spec.formatAMPM(new Date(Date.parse(calEvent.eventStart)))+'</i> <i class="icon-arrow-right"></i>   <i>'+Spec.formatAMPM(new Date(Date.parse(calEvent.eventEnd)))+"</i> <b>"+Spec.formatAMPM(calEvent.end)+"</b>")}catch(err){$("#popupContentHeader").html("<b>"+defaults.dayNames[calEvent.start.getDay()]+" | "+Spec.decodeEntities(calEvent.loc)+"</b>"),$.bootstrapGrowl("Time data of the event <b>"+Spec.lastClickedEvent.title+"</b> is improper. Please edit the event to make it's data type valid.",{type:"error",align:"center",delay:4e4})}Spec.setInventoryNumber(0,0),$("#inventory").html(""),$("#inventory").tags(_.extend(Spec._inventoryProto,{values_url:"inventory/existing/"+calEvent._id})),$.ajax({type:"GET",url:"notes/existing/"+calEvent._id}).done(function(notes){$("#popup").modalPopover("show");new Spec.View.Notes({notes:notes})})},eventRightClick:function(calEvent,jsEvent){return jsEvent.preventDefault(),calEvent.gCal===!0?!1:($('a[href="#cancelEvent"] span').text(0==calEvent.cancelled?"Cancel this event":"Uncancel this event"),void(Spec.lastClickedEvent=calEvent))},eventRender:function(event,element){if(event.gCal!==!0){symbol="",1==event.video&&(symbol+='<i class="icon-facetime-video icon-white"></i> '),1==event.audio&&(symbol+='<i class="icon-volume-up icon-white"></i> '),element.find(".fc-event-title").html(symbol+event.title),element.contextmenu({target:"#context-menu"});var shiftList=event.shifts.map(function(s){return s.staff}).filter(function(n){return n});shiftList.length>0&&element.tooltip({title:"Staff: "+shiftList.join(", ")})}},viewRender:function(){try{Spec.setTimeline(),Spec.updateTimeline()}catch(err){}},eventSources:[Spec.generateEventSource()]}),$("#calendar").fullCalendar("changeView","agendaWeek"),Spec.resizeMap(),$("#leftGroup").prependTo(".fc-header-left"),$("#rightGroup").appendTo(".fc-header-right"),$.ajax({type:"GET",url:"staff/all/"}).done(function(staff){Spec.storeAllStaff=staff}),$("#gCalButton").click(function(){$("#gCalButton").toggleClass("active"),Spec.toggleGCalEvents()}),$("#eventButton").click(function(){$("#eventButton").addClass("disabled"),$("#popup").modalPopover("hide")}),$("#addNote").click(function(){return $("#newNote").modal("show"),!1}),$("#newNote textarea").bind("keypress",function(e){return 13==(e.keyCode||e.which)?($("#noteSubmit").trigger("click"),!1):void 0}),$("#noteSubmit").click(function(){$("#newNote").modal("hide");var note=$("#newNote textarea").val();return""===note?!1:($.ajax({type:"POST",url:"notes/add",data:{note:note,eventid:Spec.lastClickedEvent._id}}).done(function(res){console.log("note added to event ID "+Spec.lastClickedEvent._id+": "+note);new Spec.View.EachNote({id:res.id,text:note,user:res.user,date:new Date})}),void $("#newNote textarea").val(""))}),$(".modal").on("show",function(){$("#popup").css("opacity",.7)}).on("hide",function(){$("#popup").css("opacity",1)}),Spec.updateStaffModal=function(){$.ajax({type:"GET",url:"staff/get/"+Spec.lastClickedEvent._id}).done(function(shifts){for(i=0;i<shifts.length;i++){var staffProfile=Spec.storeAllStaff.filter(function(staff){return staff.username==shifts[i].staff})[0];shifts[i].staffname=void 0==staffProfile?"":staffProfile.name}new Spec.View.Staff({shifts:shifts})})},$('a[href="#staffEvent"]').click(Spec.updateStaffModal),$('a[href="#editEvent"]').click(function(){new Spec.View.Edit}),$('a[href="#removeEvent"]').click(function(){new Spec.View.Remove}),$('a[href="#cancelEvent"]').click(function(){$.ajax({type:"POST",url:"event/cancel",data:{eventid:Spec.lastClickedEvent._id,make:!Spec.lastClickedEvent.cancelled}}).done(function(){console.log("event with ID "+Spec.lastClickedEvent._id+" cancel toggled"),Spec.refetchEvents()})}),$("body").on("click",".toggleDuration",function(){$.ajax({type:"POST",url:"event/techMustStay",data:{eventid:Spec.lastClickedEvent._id,make:!Spec.lastClickedEvent.techMustStay}}).done(function(){Spec.refetchEvents(),Spec.lastClickedEvent.techMustStay=!Spec.lastClickedEvent.techMustStay,Spec.techTemplateUpdate(),console.log("event with ID "+Spec.lastClickedEvent._id+" techMustStay toggled")})}),$("body").on("click",".toggleVideo",function(){$.ajax({type:"POST",url:"event/video",data:{eventid:Spec.lastClickedEvent._id,make:!Spec.lastClickedEvent.video}}).done(function(){Spec.refetchEvents(),Spec.lastClickedEvent.video=!Spec.lastClickedEvent.video,$("#popup").modalPopover("hide"),console.log("event with ID "+Spec.lastClickedEvent._id+" video toggled")})}),$("body").on("click",".toggleAudio",function(){$.ajax({type:"POST",url:"event/audio",data:{eventid:Spec.lastClickedEvent._id,make:!Spec.lastClickedEvent.audio}}).done(function(){Spec.refetchEvents(),Spec.lastClickedEvent.audio=!Spec.lastClickedEvent.audio,$("#popup").modalPopover("hide"),console.log("event with ID "+Spec.lastClickedEvent._id+" audio toggled")})}),$("body").on("click",".removeNote",function(){removedItem=this;var noteid=$(this).attr("href");return $.ajax({type:"POST",url:"notes/remove",data:{id:noteid,eventid:Spec.lastClickedEvent._id}}).done(function(){console.log("note removed from event ID "+Spec.lastClickedEvent.id+", ID: "+noteid),$(removedItem).parent().parent().remove(),Spec.setNoteNumber(-1)}),!1}),$("body").on("click","#removeEvent .btn-danger",function(){$.ajax({type:"POST",url:"event/remove",data:{eventid:Spec.lastClickedEvent._id}}).done(function(){console.log("event with ID "+Spec.lastClickedEvent._id+" removed"),Spec.refetchEvents(),$("#popup").modalPopover("hide"),$("#removeEvent").modal("hide")})}),$("body").on("click",".removeStaff",function(){removedItem=this;var shiftid=$(this).attr("href");return $.ajax({type:"POST",url:"staff/remove",data:{id:shiftid,eventid:Spec.lastClickedEvent._id}}).done(function(){Spec.lastClickedEvent.shifts.pop(),Spec.changePopupColor(Spec.lastClickedEvent),Spec.refetchEvents(),console.log("staff removed from event ID "+Spec.lastClickedEvent._id+", ID: "+shiftid),$(removedItem).parent().parent().remove()}),!1}),$("body").on("click","#addNewStaff",function(){var chosenStaff="";if(""==$(".combobox").val());else try{chosenStaff=$("#staffInput").val().match(/\(([^)]+)\)/)[1]}catch(e){chosenStaff=$(".combobox").val().match(/\(([^)]+)\)/)[1]}$.ajax({type:"POST",url:"staff/add",data:{staff:chosenStaff,start:$("#timepicker5").val(),end:$("#timepicker6").val(),eventid:Spec.lastClickedEvent._id,eventStart:Spec.lastClickedEvent.start,eventEnd:Spec.lastClickedEvent.end}}).done(function(res){Spec.refetchEvents(),console.log("staff added to event ID "+Spec.lastClickedEvent._id+": "+res.id);{var newShift={id:res.id,start:res.start,end:res.end,staff:chosenStaff,staffname:$("#staffInput").val().substring(0,$("#staffInput").val().indexOf("(")-1)};new Spec.View.EachStaff({item:newShift})}$.grep(Spec.lastClickedEvent.shifts,function(e){return e.staff==chosenStaff}).length>0&&""!=chosenStaff&&$.bootstrapGrowl("You have chosen this staff for another shift before, shift is added but you may want to check it again.",{type:"info",align:"center",delay:2e4}),Spec.lastClickedEvent.shifts.push(newShift),Spec.changePopupColor(Spec.lastClickedEvent),$(".combobox").val("")})}),Spec.updateShift=function(shiftID,newStaff){for(var i=0,l=Spec.lastClickedEvent.shifts;l>i;i++)if(Spec.lastClickedEvent.shifts[i]._id===shiftID)return void(Spec.lastClickedEvent.shifts[i].staff=newStaff)},$("body").on("click",".shiftSignUp",function(){removedItem=this;var shiftid=$(this).attr("href");return $.ajax({type:"POST",url:"staff/shiftsignup",data:{id:shiftid,eventid:Spec.lastClickedEvent._id}}).done(function(){Spec.updateShift(shiftid,Spec.username),Spec.changePopupColor(Spec.lastClickedEvent),Spec.refetchEvents(),Spec.updateStaffModal()}),!1}),$("body").on("click",".shiftWithdraw",function(){removedItem=this;var shiftid=$(this).attr("href");return $.ajax({type:"POST",url:"staff/withdraw",data:{id:shiftid,eventid:Spec.lastClickedEvent._id}}).done(function(){Spec.updateShift(shiftid,""),Spec.changePopupColor(Spec.lastClickedEvent),Spec.refetchEvents(),Spec.updateStaffModal()}),!1}),$("#editEvent .modal-footer .btn-primary").click(function(){var editTimepickers=[$("#timepickerResStart"),$("#timepickerResEnd"),$("#timepickerEventStart"),$("#timepickerEventEnd")];editTimepickers.forEach(function(pick){var result={};result[pick.prop("id")]=pick.val(),$.extend(Spec.storeEdited,result)}),Spec.storeEdited.date=new Date(Date.parse($.trim($("#startDate").text()))),Spec.storeEdited.staffNeeded=$("#editSpinner input").val(),$.ajax({type:"POST",url:"event/edit",data:{eventid:Spec.lastClickedEvent._id,changedData:Spec.storeEdited}}).done(function(){Spec.refetchEvents(),$("#editEvent").modal("hide"),$("#popup").modalPopover("hide");var title=Spec.storeEdited.title;void 0==title&&(title=Spec.lastClickedEvent.title),$.bootstrapGrowl("The event <b>"+title+"</b> is edited and saved.",{type:"info",align:"center",delay:2e3}),Spec.storeEdited={}})}),$("#collapseTwo").on("click shown keydown",function(){$(this).css("overflow","visible")}).on("hide",function(){$(this).css("overflow","hidden")}),$(document).keydown(function(e){if($(event.target).is(":not(input, textarea)"))switch(e.keyCode){case 39:$("#calendar").fullCalendar("next");break;case 37:$("#calendar").fullCalendar("prev");break;case 38:$("#calendar").fullCalendar("today")}})}),$(document).ajaxStart(function(){$("#eventButton i").removeClass("icon-book"),$("#eventButton i").addClass("icon-refresh")}),$(document).ajaxStop(function(){$("#eventButton i").removeClass("icon-refresh"),$("#eventButton i").addClass("icon-book")}),$(document).ajaxError(function(event,jqxhr,settings){"gCalEvents/"==settings.url.substring(0,11)&&(window.location.href="/authorize")})}();