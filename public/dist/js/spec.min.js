/*! Spec 0.1.2 */
!function(){var a={};a={storeAllStaff:[],username:"",permission:0,lastClickedEvent:{},View:{},filter:"",defaultFilter:"hideCancelled",updateUser:function(){$.ajax({type:"GET",url:"user/"}).done(function(b){a.username=b.username,a.permission=b.permission})},dropdownActiveFix:function(){$("a").removeClass("drop-active"),$('a[href="#'+Backbone.history.fragment+'"]').addClass("drop-active")},fullShiftNumber:function(a){return a.shifts.map(function(a){return a.staff}).filter(function(a){return a}).length},changePopupColor:function(b){$("#popupTitleButton").removeClass("btn-success btn-inverse btn-warning btn-danger btn-info");var c=a.fullShiftNumber(b);b.cancelled===!0?$("#popupTitleButton").addClass("btn-inverse"):0===c?$("#popupTitleButton").addClass("btn-danger"):c<b.staffNeeded?$("#popupTitleButton").addClass("btn-warning"):c===b.staffNeeded?$("#popupTitleButton").addClass("btn-success"):c>b.staffNeeded&&$("#popupTitleButton").addClass("btn-info"),$("#popupStaffInfo").html(c+"/"+b.staffNeeded)},resizeMap:function(){var a=$(window).height()-40;$("#calendar").fullCalendar("option","height",a),$("#modifyCSSRule").html(".fc-view-month { height:"+(a-70)+"px !important; }")},setTimeline:function(){var a=$(".fc-agenda-slots:visible").parent(),b=a.children(".timeline");0===b.length&&(b=jQuery("<hr>").addClass("timeline"),a.prepend(b));var c=new Date,d=jQuery("#calendar").fullCalendar("getView");if(!(d.visStart<c&&d.visEnd>c))return void b.hide();b.show();var e=60*c.getHours()*60+60*c.getMinutes()+c.getSeconds(),f=e/86400,g=Math.floor(a.height()*f);if(b.css("top",g+"px"),"agendaWeek"==d.name){var h=jQuery(".fc-today:visible"),i=h.position().left+1,j=h.width()-2;b.css({left:i+"px",width:j+"px"})}},updateTimeline:function(){setInterval(function(){$(".timeline").remove(),a.setTimeline()},3e5)},formatAMPM:function(a){var b=a.getHours(),c=a.getMinutes(),d=b>=12?"PM":"AM";b%=12,b=b?b:12,c=10>c?"0"+c:c;var e=b+":"+c+" "+d;return e},getFormattedDate:function(a){var b=a.getFullYear(),c=(1+a.getMonth()).toString();c=c.length>1?c:"0"+c;var d=a.getDate().toString();return d=d.length>1?d:"0"+d,c+"/"+d+"/"+b},_inventoryProto:{only_suggestions:!0,suggestion_url:"inventory/all",onRemove:function(b){var c=b.data("tag-id");$.ajax({type:"POST",url:"inventory/remove",data:{eventid:a.lastClickedEvent._id,inventoryid:b.data("tag-id")}}).done(function(){console.log("pill with ID "+c+" removed"),a.setInventoryNumber(-1)})},onBeforeAdd:function(b){return a.setInventoryNumber(1),b},onBeforeNewAdd:function(b){var c=b.data("tag-id");return $.ajax({type:"POST",url:"inventory/add",data:{eventid:a.lastClickedEvent._id,inventoryid:b.data("tag-id")}}).done(function(){console.log("pill with ID "+c+" added"),a.setInventoryNumber(1)}),b}},decodeEntities:function(a){var b,c=document.createElement("p");return c.innerHTML=a,b=c.textContent||c.innerText,c=null,b},generateEventSource:function(){var b={url:"events/?filter="+a.filter,ignoreTimezone:!1};return a.lastEventSource=b,b},gCalEventSource:{url:"gCalEvents/",ignoreTimezone:!1},boolGCal:!1,toggleGCalEvents:function(){a.boolGCal===!1?$("#calendar").fullCalendar("addEventSource",a.gCalEventSource):$("#calendar").fullCalendar("removeEventSource",a.gCalEventSource),a.boolGCal=!a.boolGCal},refetchEvents:function(){$("#calendar").fullCalendar("removeEventSource",a.lastEventSource),$("#calendar").fullCalendar("changeView","month"),$("#calendar").fullCalendar("addEventSource",a.generateEventSource()),$("#calendar").fullCalendar("changeView","agendaWeek")},techTemplateUpdate:function(){$("#technician").html(a.lastClickedEvent.techMustStay===!1?"<b>setup and breakdown</b> only.":"<b>duration of event</b>.")},setNoteNumber:function(a,b){$("#noNote").text("undefined"==typeof b?parseInt($("#noNote").text())+a:b)},setInventoryNumber:function(a,b){$("#noInventory").text("undefined"==typeof b?parseInt($("#noInventory").text())+a:b)}};var b=Backbone.Router.extend({routes:{printToday:"printToday","*filter":"all"}});a.app=new b,a.app.on("route:printToday",function(){console.log("printToday")}),a.app.on("route:all",function(b){a.dropdownActiveFix(),_.isNull(b)||_.isUndefined(b)?a.app.navigate(a.defaultFilter,{trigger:!0}):a.filter=b,a.refetchEvents(),console.log(b)}),Backbone.history.start(),_.templateSettings.variable="op",$.fn.editable.defaults.mode="inline",a.View.Edit=Backbone.View.extend({initialize:function(){this.render(),a.storeEdited={},$("#title").editable(),$("#desc").editable({title:"Description",rows:4}),$("#loc").editable(),$("#startDate").editable({format:"yyyy-mm-dd",viewformat:"mm/dd/yyyy",datepicker:{weekStart:1}}),$(".bootstrap-timepicker input").timepicker({}),$(".bootstrap-timepicker input").on("show.timepicker",function(){$(this).prev().toggle()}),$("#editSpinner").spinner(),$(".x-edit-event").on("save",function(b,c){var d={};d[this.id]=c.newValue,$.extend(a.storeEdited,d)})},render:function(){var b={event:a.lastClickedEvent},c=_.template($("#edit_template").html(),b);$("#editEvent .modal-body").html(c)}}),a.View.Remove=Backbone.View.extend({initialize:function(){this.render()},render:function(){var b={event:a.lastClickedEvent},c=_.template($("#remove_template").html(),b);$("#removeEvent").html(c)}}),a.View.Notes=Backbone.View.extend({initialize:function(b){a.setNoteNumber(0,0),this.render(b),b.notes.forEach(function(b){new a.View.EachNote(b)})},render:function(b){var c={eventid:a.lastClickedEvent._id,notes:b.notes},d=_.template($("#notes_template").html(),c);$("#notes").html(d)}}),a.View.EachNote=Backbone.View.extend({initialize:function(b){a.setNoteNumber(1),this.render(b)},render:function(b){var c={eventid:a.lastClickedEvent._id,note:b},d=_.template($("#each_note_template").html(),c);$("#notesBody").append(d)}}),a.View.Staff=Backbone.View.extend({initialize:function(a){this.render(a)},render:function(b){var c={shifts:b.shifts},d=_.template($("#staff_template").html(),c);$("#staffEvent .modal-body").html(d),a.techTemplateUpdate(),b.shifts.forEach(function(b){new a.View.EachStaff({item:b})}),a.newRowInit(b.shifts.slice(-1)[0]),$(".combobox").combobox({placeholder:"Choose a staff"}),$("#staffSpinner").spinner(),$("#staffSpinner").on("changed",function(b,c){$.ajax({type:"POST",url:"event/spinner",data:{eventid:a.lastClickedEvent._id,make:c}}).done(function(){a.refetchEvents(),a.lastClickedEvent.staffNeeded=parseInt(c),a.changePopupColor(a.lastClickedEvent),console.log("event with ID "+a.lastClickedEvent._id+" staff number changed to "+c)})})}}),a.View.EachStaff=Backbone.View.extend({initialize:function(a){this.render(a)},render:function(a){var b={item:a.item},c=_.template($("#each_staff_template").html(),b);$("#staffEvent .modal-body tbody").prepend(c)}}),a.newRowInit=function(b){var c,d;_.isUndefined(b)?(c=a.formatAMPM(a.lastClickedEvent.start),d=a.formatAMPM(a.lastClickedEvent.end)):(c=a.formatAMPM(new Date(Date.parse(b.start))),d=a.formatAMPM(new Date(Date.parse(b.end)))),$("#timepicker5").timepicker({defaultTime:c}),$("#timepicker6").timepicker({defaultTime:d}),$(".bootstrap-timepicker input").on("show.timepicker",function(){$(this).prev().toggle()}),$(".combobox").html(""),a.storeAllStaff.forEach(function(a){a.name!==!1&&$(".combobox").append($("<option>",{value:a.username}).text(a.name+" ("+a.username+")"))})},$(document).ready(function(){{var b=new Date;b.getDate(),b.getMonth(),b.getFullYear()}$("#popup").modalPopover({target:"#eventButton",placement:"bottom",backdrop:!1}),$("#calendar").fullCalendar({header:{left:"prevYear,prev,next,nextYear today",center:"title",right:"month,agendaWeek,agendaDay"},editable:!1,allDaySlot:!1,allDayDefault:!1,firstDay:b.getDay(),eventBorderColor:"black",windowResize:function(){a.resizeMap()},eventClick:function(b){if(b.gCal===!0)return!1;a.lastClickedEvent=b,$("#popup").modalPopover("hide"),symbol="",b.video===!0&&(symbol+='<i class="icon-facetime-video"></i> '),b.audio===!0&&(symbol+='<i class="icon-volume-up"></i> '),$("#eventButton").removeClass("disabled"),a.changePopupColor(b),$("#popupTitle").html(symbol+a.decodeEntities(b.title));var c;c=_.isObject(b.desc)?"":a.decodeEntities(b.desc),$("#popupContentInside").html(c);try{$("#popupContentHeader").html("<b>"+defaults.dayNames[b.start.getDay()]+" | "+a.decodeEntities(b.loc)+'</b><br><i class="icon-time"></i> <b>'+a.formatAMPM(b.start)+"</b>  <i>"+a.formatAMPM(new Date(Date.parse(b.eventStart)))+'</i> <i class="icon-arrow-right"></i>   <i>'+a.formatAMPM(new Date(Date.parse(b.eventEnd)))+"</i> <b>"+a.formatAMPM(b.end)+"</b>")}catch(d){$("#popupContentHeader").html("<b>"+defaults.dayNames[b.start.getDay()]+" | "+a.decodeEntities(b.loc)+"</b>"),$.bootstrapGrowl("Time data of the event <b>"+a.lastClickedEvent.title+"</b> is improper. Please edit the event to make it's data type valid.",{type:"error",align:"center",delay:4e4})}a.setInventoryNumber(0,0),$("#inventory").html(""),$("#inventory").tags(_.extend(a._inventoryProto,{values_url:"inventory/existing/"+b._id})),$.ajax({type:"GET",url:"notes/existing/"+b._id}).done(function(b){$("#popup").modalPopover("show");new a.View.Notes({notes:b})})},eventRightClick:function(b,c){return c.preventDefault(),b.gCal===!0?!1:($('a[href="#cancelEvent"] span').text(b.cancelled===!1?"Cancel this event":"Uncancel this event"),void(a.lastClickedEvent=b))},eventRender:function(a,b){if(a.gCal!==!0){symbol="",a.video===!0&&(symbol+='<i class="icon-facetime-video icon-white"></i> '),a.audio===!0&&(symbol+='<i class="icon-volume-up icon-white"></i> '),b.find(".fc-event-title").html(symbol+a.title),b.contextmenu({target:"#context-menu"});var c=a.shifts.map(function(a){return a.staff}).filter(function(a){return a});c.length>0&&b.tooltip({title:"Staff: "+c.join(", ")})}},viewRender:function(){try{a.setTimeline(),a.updateTimeline()}catch(b){}},eventSources:[a.generateEventSource()]}),$("#calendar").fullCalendar("changeView","agendaWeek"),a.resizeMap(),$("#leftGroup").prependTo(".fc-header-left"),$("#rightGroup").appendTo(".fc-header-right"),$.ajax({type:"GET",url:"staff/all/"}).done(function(b){a.storeAllStaff=b}),$("#gCalButton").click(function(){$("#gCalButton").toggleClass("active"),a.toggleGCalEvents()}),$("#eventButton").click(function(){$("#eventButton").addClass("disabled"),$("#popup").modalPopover("hide")}),$("#addNote").click(function(){return $("#newNote").modal("show"),!1}),$("#newNote textarea").bind("keypress",function(a){return 13==(a.keyCode||a.which)?($("#noteSubmit").trigger("click"),!1):void 0}),$("#noteSubmit").click(function(){$("#newNote").modal("hide");var b=$("#newNote textarea").val();return""===b?!1:($.ajax({type:"POST",url:"notes/add",data:{note:b,eventid:a.lastClickedEvent._id}}).done(function(c){console.log("note added to event ID "+a.lastClickedEvent._id+": "+b);new a.View.EachNote({id:c.id,text:b,user:c.user,date:new Date})}),void $("#newNote textarea").val(""))}),$(".modal").on("show",function(){$("#popup").css("opacity",.7)}).on("hide",function(){$("#popup").css("opacity",1)}),a.updateStaffModal=function(){$.ajax({type:"GET",url:"staff/get/"+a.lastClickedEvent._id}).done(function(b){for(i=0;i<b.length;i++){var c=_.findWhere(a.storeAllStaff,{username:b[i].staff});b[i].staffname=_.isUndefined(c)?"":c.name}new a.View.Staff({shifts:b})})},$('a[href="#staffEvent"]').click(a.updateStaffModal),$('a[href="#editEvent"]').click(function(){new a.View.Edit}),$('a[href="#removeEvent"]').click(function(){new a.View.Remove}),$('a[href="#cancelEvent"]').click(function(){$.ajax({type:"POST",url:"event/cancel",data:{eventid:a.lastClickedEvent._id,make:!a.lastClickedEvent.cancelled}}).done(function(){console.log("event with ID "+a.lastClickedEvent._id+" cancel toggled"),a.refetchEvents()})}),$("body").on("click",".toggleDuration",function(){$.ajax({type:"POST",url:"event/techMustStay",data:{eventid:a.lastClickedEvent._id,make:!a.lastClickedEvent.techMustStay}}).done(function(){a.refetchEvents(),a.lastClickedEvent.techMustStay=!a.lastClickedEvent.techMustStay,a.techTemplateUpdate(),console.log("event with ID "+a.lastClickedEvent._id+" techMustStay toggled")})}),$("body").on("click",".toggleVideo",function(){$.ajax({type:"POST",url:"event/video",data:{eventid:a.lastClickedEvent._id,make:!a.lastClickedEvent.video}}).done(function(){a.refetchEvents(),a.lastClickedEvent.video=!a.lastClickedEvent.video,$("#popup").modalPopover("hide"),console.log("event with ID "+a.lastClickedEvent._id+" video toggled")})}),$("body").on("click",".toggleAudio",function(){$.ajax({type:"POST",url:"event/audio",data:{eventid:a.lastClickedEvent._id,make:!a.lastClickedEvent.audio}}).done(function(){a.refetchEvents(),a.lastClickedEvent.audio=!a.lastClickedEvent.audio,$("#popup").modalPopover("hide"),console.log("event with ID "+a.lastClickedEvent._id+" audio toggled")})}),$("body").on("click",".removeNote",function(){removedItem=this;var b=$(this).attr("href");return $.ajax({type:"POST",url:"notes/remove",data:{id:b,eventid:a.lastClickedEvent._id}}).done(function(){console.log("note removed from event ID "+a.lastClickedEvent.id+", ID: "+b),$(removedItem).parent().parent().remove(),a.setNoteNumber(-1)}),!1}),$("body").on("click","#removeEvent .btn-danger",function(){$.ajax({type:"POST",url:"event/remove",data:{eventid:a.lastClickedEvent._id}}).done(function(){console.log("event with ID "+a.lastClickedEvent._id+" removed"),a.refetchEvents(),$("#popup").modalPopover("hide"),$("#removeEvent").modal("hide")})}),$("body").on("click",".removeStaff",function(){removedItem=this;var b=$(this).attr("href");return $.ajax({type:"POST",url:"staff/remove",data:{id:b,eventid:a.lastClickedEvent._id}}).done(function(){a.lastClickedEvent.shifts.pop(),a.changePopupColor(a.lastClickedEvent),a.refetchEvents(),console.log("staff removed from event ID "+a.lastClickedEvent._id+", ID: "+b),$(removedItem).parent().parent().remove()}),!1}),$("body").on("click","#addNewStaff",function(){var b="";if(""===$(".combobox").val());else try{b=$("#staffInput").val().match(/\(([^)]+)\)/)[1]}catch(c){b=$(".combobox").val().match(/\(([^)]+)\)/)[1]}$.ajax({type:"POST",url:"staff/add",data:{staff:b,start:$("#timepicker5").val(),end:$("#timepicker6").val(),eventid:a.lastClickedEvent._id,eventStart:a.lastClickedEvent.start,eventEnd:a.lastClickedEvent.end}}).done(function(c){a.refetchEvents(),console.log("staff added to event ID "+a.lastClickedEvent._id+": "+c.id);{var d={id:c.id,start:c.start,end:c.end,staff:b,staffname:$("#staffInput").val().substring(0,$("#staffInput").val().indexOf("(")-1)};new a.View.EachStaff({item:d})}$.grep(a.lastClickedEvent.shifts,function(a){return a.staff===b}).length>0&&""!==b&&$.bootstrapGrowl("You have chosen this staff for another shift before, shift is added but you may want to check it again.",{type:"info",align:"center",delay:2e4}),a.lastClickedEvent.shifts.push(d),a.changePopupColor(a.lastClickedEvent),$(".combobox").val("")})}),a.updateShift=function(b,c){for(var d=0,e=a.lastClickedEvent.shifts;e>d;d++)if(a.lastClickedEvent.shifts[d]._id===b)return void(a.lastClickedEvent.shifts[d].staff=c)},$("body").on("click",".shiftSignUp",function(){removedItem=this;var b=$(this).attr("href");return $.ajax({type:"POST",url:"staff/shiftsignup",data:{id:b,eventid:a.lastClickedEvent._id}}).done(function(){a.updateShift(b,a.username),a.changePopupColor(a.lastClickedEvent),a.refetchEvents(),a.updateStaffModal()}),!1}),$("body").on("click",".shiftWithdraw",function(){removedItem=this;var b=$(this).attr("href");return $.ajax({type:"POST",url:"staff/withdraw",data:{id:b,eventid:a.lastClickedEvent._id}}).done(function(){a.updateShift(b,""),a.changePopupColor(a.lastClickedEvent),a.refetchEvents(),a.updateStaffModal()}),!1}),$("#editEvent .modal-footer .btn-primary").click(function(){var b=[$("#timepickerResStart"),$("#timepickerResEnd"),$("#timepickerEventStart"),$("#timepickerEventEnd")];b.forEach(function(b){var c={};c[b.prop("id")]=b.val(),$.extend(a.storeEdited,c)}),a.storeEdited.date=new Date(Date.parse($.trim($("#startDate").text()))),a.storeEdited.staffNeeded=$("#editSpinner input").val(),$.ajax({type:"POST",url:"event/edit",data:{eventid:a.lastClickedEvent._id,changedData:a.storeEdited}}).done(function(){a.refetchEvents(),$("#editEvent").modal("hide"),$("#popup").modalPopover("hide");var b=a.storeEdited.title;_.isUndefined(b)&&(b=a.lastClickedEvent.title),$.bootstrapGrowl("The event <b>"+b+"</b> is edited and saved.",{type:"info",align:"center",delay:2e3}),a.storeEdited={}})}),$("#collapseTwo").on("click shown keydown",function(){$(this).css("overflow","visible")}).on("hide",function(){$(this).css("overflow","hidden")}),$(document).keydown(function(a){if($(event.target).is(":not(input, textarea)"))switch(a.keyCode){case 39:$("#calendar").fullCalendar("next");break;case 37:$("#calendar").fullCalendar("prev");break;case 38:$("#calendar").fullCalendar("today")}})}),$(document).ajaxStart(function(){$("#eventButton i").removeClass("icon-book"),$("#eventButton i").addClass("icon-refresh")}),$(document).ajaxStop(function(){$("#eventButton i").removeClass("icon-refresh"),$("#eventButton i").addClass("icon-book")}),$(document).ajaxError(function(a,b,c){"gCalEvents/"==c.url.substring(0,11)&&(window.location.href="/authorize")})}();